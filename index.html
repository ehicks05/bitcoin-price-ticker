<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>bitcoin-price-ticker</title>
    <link id="styleLink" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />

    <style>
        .red {color: red;transition: color .3s;}
        .green {color: #00C000;transition: color .3s;}
    </style>

</head>
<body>

<span id="lightBulb" style="cursor: pointer;">&#x1F4A1;</span>
<a href="charts.html" style="cursor: pointer;">&#x1F4C8;</a>
<span class="" id="time-btc"></span>
<span class="" id="socket-status">&#x2753;</span>

<section class="section">
    <div class="container">
        <header>BTC</header>
        <div style="font-size: 4em;" class="title is-1" id="price-btc"></div>
        <p>
            <span id="timeSince-btc"></span>
        </p>
        <div class="has-text-danger" id="error-btc" style="display:none;"></div>
    </div>
</section>

<section class="section">
    <div class="container">
        <header>ETH</header>
        <div style="font-size: 4em;" class="title is-1" id="price-eth"></div>
        <p>
            <span id="timeSince-eth"></span>
        </p>
        <div class="has-text-danger" id="error-eth" style="display:none;"></div>
    </div>
</section>

<script>

    document.getElementById('lightBulb').addEventListener('click', function (e)
    {
        const defaultURL = "https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css";

        const link = document.getElementById("styleLink"); // Fetch the link by its ID
        if (link.getAttribute("href") === defaultURL)
            link.setAttribute("href", "css/dark.css"); // Change its href attribute
        else
            link.setAttribute("href", defaultURL); // Change its href attribute
    });

    const subscribeMessage = {
        "type": "subscribe",
        "product_ids": [
            "BTC-USD",
            "ETH-USD"

        ],
        "channels": [
            "ticker"
        ]
    };

    const data = {
        currentTime: new Date(),
        socketReadyState: 0,
        socketReadyStateId: 'socket-status',
        btc : {
            "name": "BTC-USD",
            "lastPrice": 0,
            "lastUpdate": 0,
            "timeSinceId": "timeSince-btc",
            "timeId": "time-btc",
            "priceId": "price-btc",
            "errorId": "error-btc",
        },
        eth: {
            "name": "ETH-USD",
            "lastPrice": 0,
            "lastUpdate": 0,
            "timeSinceId": "timeSince-eth",
            "timeId": "time-eth",
            "priceId": "price-eth",
            "errorId": "error-eth",
        }
    };

    const cbSocket = new WebSocket("wss://ws-feed.pro.coinbase.com");

    function connect(socket, subscribeMessage)
    {
        socket.onopen = () => socket.send(JSON.stringify(subscribeMessage));

        socket.onmessage = event => {
            var response = JSON.parse(event.data);

            if (response.type === 'ticker')
            {
                var cryptoElement = response.product_id === 'BTC-USD' ? data.btc : data.eth;
                cryptoElement.lastUpdate = new Date();

                var price = "$" + Number.parseFloat(response.price).toFixed(2);
                flashPriceColorChange(price, cryptoElement.lastPrice, document.getElementById(cryptoElement.priceId));
                cryptoElement.lastPrice = price;
                document.getElementById(cryptoElement.priceId).innerText = price;
            }
            if (response.type === "error")
            {
                document.getElementById(cryptoElement.errorId).style.display = "block";
                document.getElementById(cryptoElement.errorId).innerText = event.data;
            }
        };

        socket.onclose = event =>
        {
            console.log('Socket is closed.  Reconnect will be attempted in 1 second', event.reason);
            setTimeout(() =>
            {
                connect(socket, subscribeMessage)
            }, 1000);
        }
    }

    connect(cbSocket, subscribeMessage);

    setInterval(() =>
    {
        data.socketReadyState = cbSocket.readyState;
        document.getElementById(data.socketReadyStateId).innerText = getSocketStatusEmoji(data.socketReadyState);
        document.getElementById(data.socketReadyStateId).title = getSocketStatus(data.socketReadyState);

        data.currentTime = new Date();
        document.getElementById(data.btc.timeId).innerText = data.currentTime.toLocaleTimeString();

        var timeSinceLastUpdateBTC = getTimeSinceLastUpdate(data.currentTime, data.btc.lastUpdate);
        document.getElementById(data.btc.timeSinceId).innerText = "Seconds since last update: " + timeSinceLastUpdateBTC;

        var timeSinceLastUpdateETH = getTimeSinceLastUpdate(data.currentTime, data.eth.lastUpdate);
        document.getElementById(data.eth.timeSinceId).innerText = "Seconds since last update: " + timeSinceLastUpdateETH;

    }, 100);

    setInterval(() => {
        if (getSocketStatus(data.socketReadyState) === 'closed')
            connect(cbSocket, subscribeMessage);
        }, 5000
    );

    function getTimeSinceLastUpdate(currentTime, lastUpdate)
    {
        return Math.round(Math.max(currentTime - lastUpdate, 0) / 1000);
    }

    function getSocketStatus(readyState)
    {
        if (readyState === 0) return "socket connecting";
        if (readyState === 1) return "socket open";
        if (readyState === 2) return "socket closing";
        if (readyState === 3) return "socket closed";
    }

    function getSocketStatusEmoji(readyState)
    {
        if (readyState === 0) return String.fromCodePoint(0x2753);
        if (readyState === 1) return String.fromCodePoint(0x2714);
        if (readyState === 2) return String.fromCodePoint(0x2753);
        if (readyState === 3) return String.fromCodePoint(0x274C);
    }

    function flashPriceColorChange(newPrice, lastPrice, priceElement)
    {
        if (newPrice > lastPrice)
            priceElement.classList.add('green');
        if (newPrice < lastPrice)
            priceElement.classList.add('red');

        setTimeout(() => priceElement.classList.remove('green', 'red'), 500)
    }

</script>

</body>
</html>
