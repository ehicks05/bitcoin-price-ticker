<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>bitcoin-price-ticker</title>
    <link id="styleLink" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css" />

    <style>
        .red {color: red;transition: color .3s;}
        .green {color: #00C000;transition: color .3s;}
        .section {padding-top: 12px;}
        .footer {padding-bottom: 48px;}

        /* font scaling from here: https://css-tricks.com/books/fundamental-css-tactics/scale-typography-screen-size/ */
        .scalingFont {font-size: calc(48px + (300 - 48) * ((100vw - 300px) / (1900 - 300))) !important; }
        .lesserScalingFont {font-size: calc(40px + (100 - 40) * ((100vw - 300px) / (1900 - 300))) !important; }
    </style>

</head>
<body>

<section class="section">
    <div class="container">
        <header class="lesserScalingFont">BTC</header>
        <div class="title is-1 scalingFont" id="price-btc"></div>
        <div class="has-text-danger" id="error-btc" style="display:none;"></div>

        <!-- TradingView Widget BEGIN -->
        <div class="tradingview-widget-container">
            <div id="tradingview_2d8dc" style="height:300px;"></div>
            <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/symbols/COINBASE-BTCUSD/" rel="noopener" target="_blank"><span class="blue-text">BTCUSD Chart</span></a> by TradingView</div>
            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
                let theme = localStorage.getItem('theme');
                if (!theme)
                    theme = 'Light';

                new TradingView.widget(
                    {
                        "autosize": true,
                        "symbol": "COINBASE:BTCUSD",
                        "interval": "D",
                        "timezone": "America/New_York",
                        "theme": theme,
                        "style": "1",
                        "locale": "en",
                        "toolbar_bg": "#f1f3f6",
                        "enable_publishing": false,
                        "hide_legend": true,
                        "container_id": "tradingview_2d8dc"
                    }
                );
            </script>
        </div>
        <!-- TradingView Widget END -->

    </div>
</section>

<section class="section" id="ethSection">
    <div class="container">
        <header class="lesserScalingFont">ETH</header>
        <div class="title is-1 scalingFont" id="price-eth"></div>
        <div class="has-text-danger" id="error-eth" style="display:none;"></div>

        <!-- TradingView Widget BEGIN -->
        <div class="tradingview-widget-container">
            <div id="tradingview_2d8de" style="height:300px;"></div>
            <div class="tradingview-widget-copyright"><a href="https://www.tradingview.com/symbols/COINBASE-BTCUSD/" rel="noopener" target="_blank"><span class="blue-text">BTCUSD Chart</span></a> by TradingView</div>
            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
            <script type="text/javascript">
                new TradingView.widget(
                    {
                        "autosize": true,
                        "symbol": "COINBASE:ETHUSD",
                        "interval": "D",
                        "timezone": "America/New_York",
                        "theme": theme,
                        "style": "1",
                        "locale": "en",
                        "toolbar_bg": "#f1f3f6",
                        "enable_publishing": false,
                        "hide_legend": true,
                        "container_id": "tradingview_2d8de"
                    }
                );
            </script>
        </div>
        <!-- TradingView Widget END -->

    </div>
</section>

<footer class="footer">
    <nav class="level">
        <div class="level-item has-text-centered">
            <span id="current-time" style="padding-right: 1em;"></span>
            <span id="socket-status" class="tag"></span>
        </div>
        <div class="level-item has-text-centered">
            <div class="buttons">
                <button class="button" id="lightBulb">&#x1F4A1;</button>
                <button class="button" id="toggleCharts">&#x1F4C8;</button>
                <button class="button" id="toggleEth">ETH</button>
            </div>
        </div>
        <div class="level-item has-text-centered">
            <span>
                <a href="https://www.github.com/ehicks05/bitcoin-price-ticker/" target="_blank">Bitcoin Price Ticker</a> by <a href="https://ehicks.net">Eric Hicks</a>
            </span>
        </div>
    </nav>
</footer>

<script>
    if (!localStorage.getItem('theme'))
        localStorage.setItem('theme', 'Light');
    if (!localStorage.getItem('showEth'))
        localStorage.setItem('showEth', 'false');
    if (!localStorage.getItem('showCharts'))
        localStorage.setItem('showCharts', 'true');

    applyTheme();
    applyShowCharts();
    applyShowEth();

    document.getElementById('lightBulb').addEventListener('click', toggleTheme);
    document.getElementById('toggleEth').addEventListener('click', toggleEth);
    document.getElementById('toggleCharts').addEventListener('click', toggleCharts);

    function toggleTheme(e)
    {
        const theme = localStorage.getItem('theme') === 'Light' ? 'Dark' : 'Light';
        localStorage.setItem('theme', theme);

        applyTheme(theme);
        new TradingView.widget(
            {
                "autosize": true,
                "symbol": "COINBASE:BTCUSD",
                "interval": "D",
                "timezone": "America/New_York",
                "theme": theme,
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_legend": true,
                "container_id": "tradingview_2d8dc"
            }
        );
        new TradingView.widget(
            {
                "autosize": true,
                "symbol": "COINBASE:ETHUSD",
                "interval": "D",
                "timezone": "America/New_York",
                "theme": theme,
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_legend": true,
                "container_id": "tradingview_2d8de"
            }
        );
    }

    function applyTheme(theme)
    {
        const defaultURL = "https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css";
        const darkURL = 'https://unpkg.com/bulmaswatch/cyborg/bulmaswatch.min.css';

        if (!theme)
            theme = localStorage.getItem('theme');

        const link = document.getElementById("styleLink"); // Fetch the link by its ID
        if (theme === 'Dark')
            link.setAttribute("href", darkURL); // Change its href attribute
        else
            link.setAttribute("href", defaultURL); // Change its href attribute
    }

    function toggleEth(e)
    {
        let showEth = localStorage.getItem('showEth') === 'true' ? 'false' : 'true';
        localStorage.setItem('showEth', showEth);

        applyShowEth(showEth);
    }

    function applyShowEth(showEth)
    {
        if (!showEth)
            showEth = localStorage.getItem('showEth');

        if (showEth === 'true')
            document.getElementById('toggleEth').classList.add('is-success');
        else
            document.getElementById('toggleEth').classList.remove('is-success');

        const ethSection = document.getElementById('ethSection');
        if (showEth === 'true')
            ethSection.style.display = 'block';
        else
            ethSection.style.display = 'none';
    }

    function toggleCharts(e)
    {
        let showCharts = localStorage.getItem('showCharts') === 'true' ? 'false' : 'true';
        localStorage.setItem('showCharts', showCharts);

        applyShowCharts(showCharts);
    }

    function applyShowCharts(showCharts)
    {
        if (!showCharts)
            showCharts = localStorage.getItem('showCharts');

        if (showCharts === 'true')
            document.getElementById('toggleCharts').classList.add('is-success');
        else
            document.getElementById('toggleCharts').classList.remove('is-success');

        const charts = document.querySelectorAll('.tradingview-widget-container');
        charts.forEach((chart) => {
            if (showCharts === 'true')
                chart.style.display = 'block';
            else
                chart.style.display = 'none';
        });
    }

    const subscribeMessage = {
        "type": "subscribe",
        "product_ids": [
            "BTC-USD",
            "ETH-USD"

        ],
        "channels": [
            "ticker"
        ]
    };

    const data = {
        currentTime: new Date(),
        currentTimeId: 'current-time',
        previousSocketReadyState: 0,
        socketReadyState: 0,
        socketReadyStateId: 'socket-status',
        showEth: localStorage.getItem('showEth'),
        btc : {
            "name": "BTC-USD",
            "lastPrice": 0,
            "lastUpdate": 0,
            "priceId": "price-btc",
            "errorId": "error-btc",
        },
        eth: {
            "name": "ETH-USD",
            "lastPrice": 0,
            "lastUpdate": 0,
            "priceId": "price-eth",
            "errorId": "error-eth",
        }
    };

    let cbSocket = new WebSocket("wss://ws-feed.pro.coinbase.com");

    function connect(socket, subscribeMessage)
    {
        socket.onopen = () => socket.send(JSON.stringify(subscribeMessage));

        socket.onmessage = event => {
            const response = JSON.parse(event.data);
            const cryptoElement = response.product_id === 'BTC-USD' ? data.btc : data.eth;

            if (response.type === 'ticker')
            {
                cryptoElement.lastUpdate = new Date();

                const price = "$" + Number.parseFloat(response.price).toFixed(2);
                flashPriceColorChange(price, cryptoElement.lastPrice, document.getElementById(cryptoElement.priceId));
                cryptoElement.lastPrice = price;
                document.getElementById(cryptoElement.priceId).innerText = price;

                if (response.product_id === 'BTC-USD')
                    document.title = price + ' BTC-USD';
            }
            if (response.type === "error")
            {
                document.getElementById(cryptoElement.errorId).style.display = "block";
                document.getElementById(cryptoElement.errorId).innerText = event.data;
            }
        };

        socket.onclose = event => console.log('Socket onclose event has fired. Reason: ' + event.reason);
    }

    connect(cbSocket, subscribeMessage);

    setInterval(() =>
    {
        if (cbSocket.readyState !== data.socketReadyState)
        {
            data.previousSocketReadyState = data.socketReadyState;
            data.socketReadyState = cbSocket.readyState;
            document.getElementById(data.socketReadyStateId).classList.remove(getSocketStatusClass(data.previousSocketReadyState));
            document.getElementById(data.socketReadyStateId).classList.add(getSocketStatusClass(data.socketReadyState));
            document.getElementById(data.socketReadyStateId).title = getSocketStatus(data.socketReadyState);
            document.getElementById(data.socketReadyStateId).innerText = getSocketStatus(data.socketReadyState);
            
            changeFavicon(getFavicon(data.socketReadyState));
        }

        data.currentTime = new Date();
        document.getElementById(data.currentTimeId).innerText = data.currentTime.toLocaleTimeString();

        const timeSinceLastUpdateBTC = getTimeSinceLastUpdate(data.currentTime, data.btc.lastUpdate);
        document.getElementById(data.btc.priceId).title = "Seconds since last update: " + timeSinceLastUpdateBTC;

        const timeSinceLastUpdateETH = getTimeSinceLastUpdate(data.currentTime, data.eth.lastUpdate);
        document.getElementById(data.eth.priceId).title = "Seconds since last update: " + timeSinceLastUpdateETH;

    }, 100);

    setInterval(checkConnection, 1000);

    function checkConnection()
    {
        if (getSocketStatus(data.socketReadyState) === 'Closed')
        {
            cbSocket = new WebSocket("wss://ws-feed.pro.coinbase.com");
            connect(cbSocket, subscribeMessage);
        }
    }

    function getTimeSinceLastUpdate(currentTime, lastUpdate)
    {
        return Math.round(Math.max(currentTime - lastUpdate, 0) / 1000);
    }

    function getSocketStatus(readyState)
    {
        if (readyState === 0) return "Connecting";
        if (readyState === 1) return "Connected";
        if (readyState === 2) return "Closing";
        if (readyState === 3) return "Closed";
    }

    function getSocketStatusClass(readyState)
    {
        if (readyState === 0) return "is-info";
        if (readyState === 1) return "is-success";
        if (readyState === 2) return "is-warning";
        if (readyState === 3) return "is-danger";
    }

    function getFavicon(readyState)
    {
        if (readyState === 0) return "img/yellow.ico";
        if (readyState === 1) return "img/green.ico";
        if (readyState === 2) return "img/yellow.ico";
        if (readyState === 3) return "img/red.ico";
    }

    function flashPriceColorChange(newPrice, lastPrice, priceElement)
    {
        if (newPrice > lastPrice)
            priceElement.classList.add('green');
        if (newPrice < lastPrice)
            priceElement.classList.add('red');

        setTimeout(() => priceElement.classList.remove('green', 'red'), 500)
    }

    function changeFavicon(src) {
        var link = document.createElement('link'),
            oldLink = document.getElementById('dynamic-favicon');
        link.id = 'dynamic-favicon';
        link.rel = 'shortcut icon';
        link.href = src;
        if (oldLink) {
            document.head.removeChild(oldLink);
        }
        document.head.appendChild(link);
    }

</script>

</body>
</html>
