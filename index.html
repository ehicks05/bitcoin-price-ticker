<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>bitcoin-price-ticker</title>
    
    <style>
        body {display:flex; flex-direction: column; height: 100vh; margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, avenir next, avenir, helvetica neue, helvetica, Ubuntu, roboto, noto, segoe ui, arial, sans-serif;
        }
        .red {animation: down .7s;}
        .green {animation: up .7s;}

        @keyframes up {
            0% {background-color: transparent;}
            10% {background-color: rgba(0, 200, 0, .5);}
            100% {background-color: transparent;}
        }

        @keyframes down {
            0% {background-color: transparent;}
            10% {background-color: rgba(200, 0, 0, .5);}
            100% {background-color: transparent;}
        }

        a {text-decoration: none; color: hsl(217, 71%, 53%);}
        .section {padding: 1rem 1.5rem 3rem 1.5rem;}
        .title {   
            display: inline-block;
            font-size: 2rem;
            font-weight: 600;
            line-height: 1.125;
        }

        /* font scaling from here: https://css-tricks.com/books/fundamental-css-tactics/scale-typography-screen-size/ */
        .scalingFont-xl {font-size: calc(46px + 340 * ((100vw - 320px) / 1680)) !important; }
        .scalingFont-l {font-size: calc(42px + 280 * ((100vw - 320px) / 1680)) !important; }
        .scalingFont-m {font-size: calc(32px + 240 * ((100vw - 320px) / 1680)) !important; }
        .scalingFont-s {font-size: calc(16px + 160 * ((100vw - 320px) / 1680)) !important; }
        .lesserScalingFont {font-size: calc(20px + (80 - 20) * ((100vw - 320px) / (2000 - 320))) !important; }

        .is-success {background-color: #23d160 !important; color: #fff !important;}
        .is-info {background-color: hsl(204, 86%, 53%) !important; color: #fff !important;}
        .is-warning {background-color: hsl(48, 100%, 67%) !important; color: #000 !important;}
        .is-danger {background-color: hsl(348, 100%, 61%) !important; color: #fff !important;}

        .buttons {display: flex;}
        .buttons .button:not(:last-child) {margin-right: .5rem;}
        .button {display: flex; padding: .5rem 1rem; border-radius: 4px; cursor: pointer; color: #333; background-color: #eee; border: 1px solid #666;}
        @media (prefers-color-scheme: dark) {
            .button {color: #eee; background-color: #222;}
        }

        footer {padding: 3rem 1.5rem;}
        .level {display: flex; flex-direction: column; align-items: center; justify-content: space-between;}
        @media (min-width: 680px) {
            .level {flex-direction: row;}
        }

        .level-item {width:100%; flex-grow: 1; justify-content: center; display: flex; margin-top: 1rem; align-items: center;}
        @media (min-width: 680px) {
            .level-item {margin-top: 0; width: calc(100%/3);}
            .justify-start {justify-content: flex-start;}
            .justify-end {justify-content: flex-end;}
        }

        .tag {
            align-items: center;
            border-radius: 4px;
            display: inline-flex;
            font-size: .75rem;
            height: 2em;
            justify-content: center;
            padding-left: .75em;
            padding-right: .75em;
            white-space: nowrap;
        }

        body {height: 100vh; color: #111; background-color: #fefefe;}
        @media (prefers-color-scheme: dark) {
            body {color: #eee; background-color: #111;}
        }
    </style>

</head>
<body>
<section class="section">
    <div>
        <div class="lesserScalingFont">BTC</div>
        <div class="title scalingFont" id="price-btc"></div>
    </div>
</section>

<section class="section" id="ethSection">
    <div>
        <div class="lesserScalingFont">ETH</div>
        <div class="title scalingFont" id="price-eth"></div>
    </div>
</section>
<div style="flex-grow: 1;"></div>
<footer>
    <div class="level">
        <div class="level-item justify-start">
            <span id="socket-status" class="tag"></span>
        </div>
        <div class="level-item">
            <div class="buttons">
                <button class="button" id="toggleEth">ETH</button>
                <button class="button font-size-button" id="fontSize-s">S</button>
                <button class="button font-size-button" id="fontSize-m">M</button>
                <button class="button font-size-button" id="fontSize-l">L</button>
                <button class="button font-size-button" id="fontSize-xl">XL</button>
            </div>
        </div>
        <div class="level-item justify-end">
            <span style="display:flex; align-items: center;">
                <a href="https://www.github.com/ehicks05/bitcoin-price-ticker/" target="_blank">github</a>
                &nbsp;&centerdot;&nbsp; <a href="https://ehicks.net">ehicks</a>
            </span>
        </div>
    </div>
</footer>

<script>
    if (!localStorage.getItem('showEth'))
        localStorage.setItem('showEth', 'false');
    if (!localStorage.getItem('fontSize'))
        localStorage.setItem('fontSize', 'l');

    applyShowEth();
    applyFontSize();

    document.getElementById('toggleEth').addEventListener('click', toggleEth);
    document.querySelectorAll('.font-size-button').forEach(element => element.addEventListener('click', changeFontSize));

    function changeFontSize(e)
    {
        applyFontSize(e.target.id.replace('fontSize-', ''));
    }

    function applyFontSize(size)
    {
        if (!size)
            size = localStorage.getItem('fontSize');
        localStorage.setItem('fontSize', size);

        document.querySelectorAll('.scalingFont').forEach(el => {
            ['xl', 'l', 'm', 's'].forEach(size => {
                el.classList.remove('scalingFont-' + size);
                document.getElementById('fontSize-' + size).classList.remove('is-success')
            });

            el.classList.add('scalingFont-' + size);
            document.getElementById('fontSize-' + size).classList.add('is-success')
        });
    }

    function toggleEth(e)
    {
        let showEth = localStorage.getItem('showEth') === 'true' ? 'false' : 'true';
        localStorage.setItem('showEth', showEth);

        applyShowEth(showEth);
    }

    function applyShowEth(showEth)
    {
        if (!showEth)
            showEth = localStorage.getItem('showEth');

        if (showEth === 'true')
            document.getElementById('toggleEth').classList.add('is-success');
        else
            document.getElementById('toggleEth').classList.remove('is-success');

        document.getElementById('ethSection').style.display = showEth === 'true' ? 'block' : 'none';
    }

    const subscribeMessage = {
        "type": "subscribe",
        "product_ids": [
            "BTC-USD",
            "ETH-USD"
        ],
        "channels": [
            "ticker"
        ]
    };

    const data = {
        previousSocketReadyState: 0,
        socketReadyState: 0,
        socketReadyStateId: 'socket-status',
        showEth: localStorage.getItem('showEth'),
        btc : {
            "name": "BTC-USD",
            "lastPrice": 0,
            "lastUpdate": 0,
            "priceId": "price-btc",
            "errorId": "error-btc",
        },
        eth: {
            "name": "ETH-USD",
            "lastPrice": 0,
            "lastUpdate": 0,
            "priceId": "price-eth",
            "errorId": "error-eth",
        }
    };

    let cbSocket = new WebSocket("wss://ws-feed.pro.coinbase.com");

    function connect(socket, subscribeMessage)
    {
        socket.onopen = () => socket.send(JSON.stringify(subscribeMessage));

        socket.onmessage = event => {
            const response = JSON.parse(event.data);
            const cryptoElement = response.product_id === 'BTC-USD' ? data.btc : data.eth;

            if (response.type === 'ticker')
            {
                cryptoElement.lastUpdate = new Date();

                const price = Number.parseFloat(response.price);
                flashPriceColorChange(price, cryptoElement.lastPrice, document.getElementById(cryptoElement.priceId));
                cryptoElement.lastPrice = price;
                document.getElementById(cryptoElement.priceId).innerText = Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(price);

                if (response.product_id === 'BTC-USD')
                    document.title = price + ' BTC-USD';
            }
            if (response.type === "error")
            {
                document.getElementById(cryptoElement.errorId).style.display = "block";
                document.getElementById(cryptoElement.errorId).innerText = event.data;
            }
        };

        socket.onclose = event => console.log('Socket onclose event has fired. Reason: ' + event.reason);
    }

    connect(cbSocket, subscribeMessage);

    setInterval(() =>
    {
        if (cbSocket.readyState !== data.socketReadyState)
        {
            data.previousSocketReadyState = data.socketReadyState;
            data.socketReadyState = cbSocket.readyState;
            document.getElementById(data.socketReadyStateId).classList.remove(SOCKET_STATUSES[data.previousSocketReadyState].class);
            document.getElementById(data.socketReadyStateId).classList.add(SOCKET_STATUSES[data.socketReadyState].class);
            document.getElementById(data.socketReadyStateId).innerText = SOCKET_STATUSES[data.socketReadyState].name;
            
            changeFavicon(SOCKET_STATUSES[data.socketReadyState].favicon);
        }
    }, 100);

    setInterval(checkConnection, 1000);

    function checkConnection()
    {
        if (SOCKET_STATUSES[data.socketReadyState].name === 'Closed')
        {
            cbSocket = new WebSocket("wss://ws-feed.pro.coinbase.com");
            connect(cbSocket, subscribeMessage);
        }
    }

    const SOCKET_STATUSES = {
        0: { name: 'Connecting', class: 'is-info', favicon: 'img/yellow.ico' },
        1: { name: 'Connected', class: 'is-success', favicon: 'img/green.ico' },
        2: { name: 'Closing', class: 'is-warning', favicon: 'img/yellow.ico' },
        3: { name: 'Closed', class: 'is-danger', favicon: 'img/red.ico' },
    }

    let timeout;
    function flashPriceColorChange(newPrice, lastPrice, priceElement)
    {
        if (newPrice === lastPrice) return;
        clearTimeout(timeout);
        priceElement.classList.remove('green', 'red');

        // force animation restart (https://css-tricks.com/restart-css-animation/)
        void priceElement.offsetWidth;

        if (newPrice > lastPrice)
            priceElement.classList.add('green');
        if (newPrice < lastPrice)
            priceElement.classList.add('red');

        timeout = setTimeout(() => priceElement.classList.remove('green', 'red'), 700);
    }

    function changeFavicon(src) {
        var link = document.createElement('link'),
            oldLink = document.getElementById('dynamic-favicon');
        link.id = 'dynamic-favicon';
        link.rel = 'shortcut icon';
        link.href = src;
        if (oldLink) {
            document.head.removeChild(oldLink);
        }
        document.head.appendChild(link);
    }

</script>

</body>
</html>
